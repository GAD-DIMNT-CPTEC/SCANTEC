!!RMF!! SVBS      80413 MARACAY_-_B.A._SUCRE             -- VN  10.25  -67.65   437  0
!!RMF!! SVCB      80444 CIUDAD_BOLIVAR                   -- VN   8.15  -63.55    48  0
!!RMF!! SVSA      80447 SAN_ANTONIO_DEL_TACHIRA          -- VN   7.85  -72.45   378  0
!!RMF!! SVSR      80450 SAN_FERNANDO_DE_APURE            -- VN   7.90  -67.41    48  0
!!RMF!! SOCA      81405 CAYENNE_ROCHAMBEAU               -- FG   4.83  -52.36     9  0
!!RMF!! SKBO      80222 BOGOTA/ELDORADO                  -- CO   4.70  -74.15  2546  0
!!RMF!! SBBV      82022 BOA_VISTA                        -- BZ   2.83  -60.70   140  0
!!RMF!! SBTS      82026 TIRIOS                           -- BZ   2.22  -55.93   325  0
!!RMF!! SBMQ      82099 MACAPA                           -- BZ   0.05  -51.67    16  0
!!RMF!! SBUA      82107 S_GABRIEL_DA_CACHOEIRA           -- BZ  -0.13  -67.05    79  0
!!RMF!! SBBE      82193 BELEM_(AEROPORTO)                -- BZ  -1.38  -48.48    16  0
!!RMF!! SBSN      82244 SANTAREM_INTL_ARPT               -- BZ  -2.43  -54.72    72  0
!!RMF!! SBSL      82281 SAO_LUIS_MARECHAL(AERO)          -- BZ  -2.60  -44.23    53  0
!!RMF!! AAAA      84378 MORONA_Iquitos                   -- PR  -3.73  -73.25   117  0
!!RMF!! SBMN      82332 MANAUS_(AEROPORTO)               -- BZ  -3.15  -59.98    84  0
!!RMF!! AAAA      82397 FORTALEZA                        -- BZ  -3.76  -38.60    19  0
!!RMF!! SBFN      82400 FERNANDO_DE_NORONHA              -- BZ  -3.85  -32.41    45  0
!!RMF!! SBTT      82411 TABATINGA_ARPT                   -- BZ  -3.67  -69.67    85  0
!!RMF!! SBMY      82532 MANICORE                         AM BZ  -5.82  -61.30    49  0
!!RMF!! SBNT      82599 NATAL_AEROPORTO                  -- BZ  -5.91  -35.25    49  0
!!RMF!! AAAA      82678 FLORIANO                         -- BZ  -6.76  -43.01   123  0
!!RMF!! SBCZ      82705 CRUZEIRO_DO_SUL                  AC BZ  -7.60  -72.77   199  0
!!RMF!! AAAA      82765 CAROLINA                         -- BZ  -7.33  -47.46   192  0
!!RMF!! SBPV      82824 PORTO_VELHO_(AEROPORTO)          -- BZ  -8.76  -63.91   102  0
!!RMF!! AAAA      82900 RECIFE                           -- BZ  -8.05  -34.91    11  0
!!RMF!! SBAT      82965 ALTA_FLORESTA_(AERO)             -- BZ  -9.86  -56.10   288  0
!!RMF!! AAAA      82983 PETROLINA                        -- BZ  -9.38  -40.48   370  0
!!RMF!! SBRB      82917 RIO_BRANCO/MEDICI                -- BZ -10.00  -67.80   143  0
!!RMF!! SBVH      83208 VILHENA_(AEROPORTO)              -- BZ -12.70  -60.10   652  0
!!RMF!! AAAA      83229 SALVADOR                         -- BZ -13.01  -38.51    51  0
!!RMF!! SBLP      83288 BOM_JESUS_DA_LAPA                -- BZ -13.26  -43.41   440  0
!!RMF!! SBCY      83362 CUIABA_(AEROPORTO)               -- BZ -15.65  -56.10   182  0
!!RMF!! SBBR      83378 BRASILIA_(AEROPORTO)             -- BZ -15.86  -47.93  1061  0
!!RMF!! AAAA      83498 CARAVELAS                        -- BZ -17.73  -39.25     3  0
!!RMF!! SBUL      83525 UBERLANDIA                       -- BZ -18.90  -48.23   922  0
!!RMF!! AAAA      83554 CORUMBA                          -- BZ -19.00  -57.67   142  0
!!RMF!! AAAA      83566 CONFIS_INTNL_ARPT                -- BZ -19.62  -43.57   827  0
!!RMF!! SBCG      83612 CAMPO_GRANDE_(AERO)              -- BZ -20.46  -54.66   567  0
!!RMF!! SBVT      83649 VITORIA_GOIABEIRAS               -- BZ -20.27  -40.28     4  0
!!RMF!! AAAA      83650 TRINDADE_(ILHA)                  -- BZ -20.50  -29.31     4  0
!!RMF!! SBGL      83746 GALEAO                           -- BZ -22.81  -43.25    42  0
!!RMF!! SBLO      83768 LONDRINA_AIRPORT                 -- BZ -23.33  -51.13   570  0
!!RMF!! SCFA      85442 ANTOFAGASTA                      -- CH -23.43  -70.45   137  0
!!RMF!! SBMT      83779 MARTE_CIV/MIL                    -- BZ -23.52  -46.63   722  0
!!RMF!! SBFI      83827 FOZ_DO_IGUACU_(AERO)             -- BZ -25.51  -54.58   180  0
!!RMF!! SBCT      83840 CURITIBA_(AEROPORTO)             -- BZ -25.51  -49.16   908  0
!!RMF!! SARE      87155 RESISTENCIA_AERO                 -- AG -27.45  -59.05    52  0
!!RMF!! SBFL      83899 FLORIANOPOLIS_ARPT               -- BZ -27.67  -48.55     5  0
!!RMF!! SBUG      83928 URUGUAIANA_RUBEM(AERO)           -- BZ -29.78  -57.03    74  0
!!RMF!! SBSM      83937 SANTA_MARIA                      -- BZ -29.70  -53.70    85  0
!!RMF!! SBPA      83971 PORTO_ALEGRE_(AERO)              -- BZ -30.00  -51.18     3  0
!!RMF!! SACO      87344 CORDOBA_AERO                     -- AG -31.32  -64.22   474  0
!!RMF!! SCSN      85586 SANTO_DOMINGO                    -- CH -33.65  -71.61    75  0
!!RMF!! SAEZ      87576 EZEIZA_AERO                      -- AG -34.81  -58.53    20  0
!!RMF!! SAZR      87623 SANTA_ROSA_AERO                  -- AG -36.56  -64.26   191  0
!!RMF!! SCTE      85799 PUERTO_MONTT                     -- CH -41.43  -73.10    79  0
!!RMF!! SAVC      87860 COMODORO_RIVADAVIA_AERO          -- AG -45.78  -67.50    46  0



module m_radiossonda

  USE scamtec_module
  USE SCAM_dataMOD, only : scamdata
  USE interp_mod
  USE SCAM_OutputMOD , only: write_2d   !

  implicit none
  
  private
  
  type radio_type_dec 

     integer            :: npts
     real, pointer      :: gridDesc(:)
     real, pointer      :: rlat1(:)
     real, pointer      :: rlon1(:)
     integer, pointer   :: n111(:)
     integer, pointer   :: n121(:)
     integer, pointer   :: n211(:)
     integer, pointer   :: n221(:)
     real, pointer      :: w111(:),w121(:)
     real, pointer      :: w211(:),w221(:)

  end type radio_type_dec
  
  type radio_info
  
  	integer			:: ct
	real, dimension(3) 	:: coord
	real, dimension(4)	:: h   ! geo
	real, dimension(4)	:: p   ! pressao
	real, dimension(4)	:: tc  ! temp. do ar		C
	real, dimension(4)	:: td  ! temp. ponto de orvalho C
	real, dimension(4)	:: dir ! direcao
	real, dimension(4)	:: mag ! velocidade do vento
  
  end type radio_info

  type(radio_info), dimension(80001:87860) :: sites

  type(radio_type_dec) :: radio_struc

  public :: brams_radio
  public :: radio_read
  public :: radio_init

  character(len=*),parameter :: myname='m_radio'

  contains
  
 subroutine radio_init()

    integer 			:: nx 
    integer 			:: ny
    character(len=*),parameter	:: myname_=myname//'::radio_init'

#ifdef DEBUG
    	write(6,'(     2A)')'Hello from ', myname_
#endif

    	allocate(radio_struc%gridDesc(50))

    	call radio_domain()

    	nx = int(scamtec%gridDesc(2))
    	ny = int(scamtec%gridDesc(3))

    	allocate(radio_struc%rlat1(nx*ny))
    	allocate(radio_struc%rlon1(nx*ny))              
    	allocate(radio_struc%n111(nx*ny))
    	allocate(radio_struc%n121(nx*ny))
    	allocate(radio_struc%n211(nx*ny))
    	allocate(radio_struc%n221(nx*ny))
    	allocate(radio_struc%w111(nx*ny))
    	allocate(radio_struc%w121(nx*ny))
    	allocate(radio_struc%w211(nx*ny))
    	allocate(radio_struc%w221(nx*ny))

    	call bilinear_interp_input(radio_struc%gridDesc, scamtec%gridDesc,        &
        	                   int(scamtec%gridDesc(2)*scamtec%gridDesc(3)), &
                                   radio_struc%rlat1,radio_struc%rlon1,      &
                                   radio_struc%n111,radio_struc%n121,        &
                                   radio_struc%n211,radio_struc%n221,        &
                                   radio_struc%w111,radio_struc%w121,        &
                                   radio_struc%w211,radio_struc%w221)
				   
	!- filling radiossonda info
	sites(:)%ct = 0
	
	sites(80413)%coord = (/10.25,  -67.65 , 437/)
	sites(80444)%coord = (/8.15,  -63.55  ,  48/)
	sites(80447)%coord = (/7.85,  -72.45  , 378/)
	sites(80450)%coord = (/7.90,  -67.41  ,  48/)
	sites(81405)%coord = (/4.83,  -52.36  ,   9 /)
	sites(80222)%coord = (/4.70,  -74.15  ,2546 /)
	sites(82022)%coord = (/2.83,  -60.70  , 140 /)
	sites(82026)%coord = (/2.22,  -55.93  , 325 /)
	sites(82099)%coord = (/0.05,  -51.67  ,  16 /)
	sites(82107)%coord = (/-0.13,  -67.05 ,  79/)
	sites(82193)%coord = (/-1.38,  -48.48 ,  16/)
	sites(82244)%coord = (/-2.43,  -54.72 ,  72/)
	sites(82281)%coord = (/-2.60,  -44.23 ,  53/)    
	sites(84378)%coord = (/-3.73,  -73.25 , 117/)
	sites(82332)%coord = (/-3.15,  -59.98 ,  84/)
	sites(82397)%coord = (/-3.76,  -38.60 ,  19/)
	sites(82400)%coord = (/-3.85,  -32.41 ,  45/)
	sites(82411)%coord = (/-3.67,  -69.67 ,  85/)
	sites(82532)%coord = (/-5.82,  -61.30 ,  49/)
	sites(82599)%coord = (/-5.91,  -35.25 ,  49/)  
	sites(82678)%coord = (/-6.76,  -43.01 , 123/)   
	sites(82705)%coord = (/-7.60,  -72.77 , 199/)
	sites(82765)%coord = (/-7.33,  -47.46 , 192/)
	sites(82824)%coord = (/-8.76,  -63.91 , 102/)
	sites(82900)%coord = (/-8.05,  -34.91 ,  11/)
	sites(82965)%coord = (/-9.86,  -56.10 , 288/)
	sites(82983)%coord = (/-9.38,  -40.48 , 370/)  
	sites(82917)%coord = (/-10.00,  -67.80, 143/)
	sites(83208)%coord = (/-12.70,  -60.10, 652/)
	sites(83229)%coord = (/-13.01,  -38.51,  51/)   
	sites(83288)%coord = (/-13.26,  -43.41, 440/)   
	sites(83362)%coord = (/-15.65,  -56.10, 182/)
	sites(83378)%coord = (/-15.86,  -47.93,1061/)
	sites(83498)%coord = (/-17.73,  -39.25,   3/)  
	sites(83525)%coord = (/-18.90,  -48.23, 922/)
	sites(83554)%coord = (/-19.00,  -57.67, 142/)
	sites(83566)%coord = (/-19.62,  -43.57, 827/)   
	sites(83612)%coord = (/-20.46,  -54.66, 567/)
	sites(83649)%coord = (/-20.27,  -40.28,   4/)  
	sites(83650)%coord = (/-20.50,  -29.31,   4/)
	sites(83746)%coord = (/-22.81,  -43.25,  42/)   
	sites(83768)%coord = (/-23.33,  -51.13, 570/)
	sites(85442)%coord = (/-23.43,  -70.45, 137/)
	sites(83779)%coord = (/-23.52,  -46.63, 722/)
	sites(83827)%coord = (/-25.51,  -54.58, 180/)
	sites(83840)%coord = (/-25.51,  -49.16, 908/)
	sites(87155)%coord = (/-27.45,  -59.05,  52/)
	sites(83899)%coord = (/-27.67,  -48.55,   5/)
	sites(83928)%coord = (/-29.78,  -57.03,  74/)
	sites(83937)%coord = (/-29.70,  -53.70,  85/)
	sites(83971)%coord = (/-30.00,  -51.18,   3/)
	sites(87344)%coord = (/-31.32,  -64.22, 474/)
	sites(85586)%coord = (/-33.65,  -71.61,  75/)
	sites(87576)%coord = (/-34.81,  -58.53,  20/)
	sites(87623)%coord = (/-36.56,  -64.26, 191/)
	sites(85799)%coord = (/-41.43,  -73.10,  79/)
	sites(87860)%coord = (/-45.78,  -67.50,  46/)
	
	sites(85469)%coord = (/-27.15000,-109.43000,51/)
	sites(80001)%coord = (/12.58000, -81.72000, 6/)
	sites(80462)%coord = (/4.60000, -61.12000, 907/)
	sites(85934)%coord = (/-53.00000, -70.97000, 37/)
	sites(87047)%coord = (/-24.85000, -65.48000, 1221/)
	sites(87418)%coord = (/-32.83000, -68.78000, 704/)
 end subroutine radio_init

 subroutine radio_domain()

    character(len=*),parameter :: myname_=myname//'::radio_domain'

#ifdef DEBUG
	write(6,'(     2A)')'Hello from ', myname_
#endif

    	radio_struc%gridDesc     = 0 

	radio_struc%gridDesc( 1) = 0         !Input grid type (4=Gaussian)
    	radio_struc%gridDesc( 2) = 291       !Number of points on a lat circle
    	radio_struc%gridDesc( 3) = 343        !Number of points on a meridian
    	radio_struc%gridDesc( 4) = -47   !Latitude of origin
	radio_struc%gridDesc( 5) = -82.133       !Longitude of origin
    	radio_struc%gridDesc( 6) = 128       !8 bits (1 byte) related to resolution
                                             !(recall that 10000000 = 128), Table 7
    	radio_struc%gridDesc( 7) = 11.14  !Latitude of extreme point
    	radio_struc%gridDesc( 8) = -26.743    !Longitude of extreme point
    	radio_struc%gridDesc( 9) = 0.170     !N/S direction increment (delta y)
    	radio_struc%gridDesc(10) = 0.191       !(Gaussian) # lat circles pole-equator (delta x)
    	radio_struc%gridDesc(20) = 0.0 

    	radio_struc%npts = radio_struc%gridDesc(2)*radio_struc%gridDesc(3)

 end subroutine radio_domain

!############################################################################################################
!->Inicio do comentario
!->Subrotina: brams_radio
!->Descrição: transforma matriz do BRAMS em pontos de RADIO SONDA
!->Variaveis
!x1			: numero de pontos em X
!x2			: numero de pontos em Y
!f			: matriz com o dado do BRAMS
!px			: posição de x convertida para ponto de grade
!py			: posição de y convertida para ponto de grade
!i,j			: variaveis de controle
!siteId			: coordenadas das estações
!f_temp			: matriz temporaria
!f_novo			: nova matriz do brams com pontos de radio sonda
!
!############################################################################################################

 subroutine brams_radio(f,x1,x2)
 implicit none

 integer,intent(in)                             :: x1
 integer,intent(in)                             :: x2
 real,dimension(:,:),intent(inout)              :: f
 integer					:: px
 integer					:: py
 integer                                        :: k
 integer                                        :: nx
 integer                                        :: ny
 integer                                        :: i
 integer                                        :: j
 integer					:: siteId
 real,dimension(:,:),allocatable                ::f_temp
 real,dimension(:,:),allocatable                ::f_novo
 character(len=50)                              :: OutFName
   allocate(f_novo(x1,x2))

   f_novo=-9999.0


    !
    ! invertendo y
    !

	allocate(f_temp(x1,x2))
    

	nx = int(radio_struc%gridDesc(2))
	ny = int(radio_struc%gridDesc(3))

 
 	k = 0
 	do j = 1, ny
    		do i = 1, nx
       			f_temp(i+(nx*ny)-nx-k,:) = f(i+k,:)
    		enddo
  		k = k + nx
	enddo
		
	f = f_temp

 	deallocate(f_temp)



	do siteId = 80001, 87860

			if(sites(siteId)%ct .eq. 4)then
	
				px = ((sites(siteId)%coord(2) - radio_struc%gridDesc(5))/radio_struc%gridDesc( 10) ) + 1
				py = ((radio_struc%gridDesc(7) - sites(siteId)%coord(1))/radio_struc%gridDesc( 9) ) + 1

				if(px .gt. 0 .and. px .le. radio_struc%gridDesc(2) .and. py .gt. 0 .and. py .le. radio_struc%gridDesc(3))then

					f_novo( (((py-1)*radio_struc%gridDesc(2)) + px), :)=f( (((py-1)*radio_struc%gridDesc(2)) + px), :)

				endif

			endif


	enddo
	f=f_novo
end subroutine brams_radio

!############################################################################################################
!->Inicio do comentario
!->Subrotina: radio_read
!->Descrição: Leiitura de arquivo texto de RADIO SONDA
!->Variaveis
!x1			: numero de pontos em X
!x2			: numero de pontos em Y
!f			: matriz com o dado do BRAMS
!px			: posição de x convertida para ponto de grade
!py			: posição de y convertida para ponto de grade
!i,j,k,iv		: variaveis de controle
!siteId			: coordenadas das estações
!temp			: matriz temporaria
!f			: matriz temporaria
!f2			:matriz de organização
!fname			: nome do arquivo
!file_exists		: verificação de arquivo
!lineStream		:?
!istat			:?
!nx			: numero de pontos em X
!ny			: numero de pontos em Y
!kpds			:?
!varfiels		: matriz principal
!lb			:?
!h			: altura geopotencial
!p			: pressão
!tc			: temperatura do ar
!td			: temperatura no ponto de orvalho
!dir			: direção do vento
!mag			: magnitude do vento
!outFName		: nome do arquivo de saida do write2d
!pi,e,gmsl,Pd,es,r	: variaveis de conversão			
!############################################################################################################
 
 subroutine radio_read(fname)
 
  character(len=*), intent(in)			:: fname
  real, dimension(:,:), allocatable		:: f
  real, dimension(:,:), allocatable		:: f2
  logical 					:: file_exists
  character(len=225)				:: lineStream
  integer					:: istat
  integer					:: siteId
  integer					:: px
  integer					:: py
  integer					:: nx
  integer					:: ny
  integer 					:: kpds(200)
  real, dimension(:,:), allocatable 		:: varfield
  logical*1, dimension(:), allocatable 		:: lb
  
  real						:: h  
  real						:: p  
  real						:: tc 
  real						:: td 
  real						:: dir
  real						:: mag
  
  integer					:: i, j, k, iv
  
  real, dimension(:,:), allocatable		:: temp
  character(len=50)                             :: outFName
  real, parameter                               :: pi=3.1415927, e=0.622, gmsl=9.81, Rd=287
  real,dimension(:),allocatable                                         :: es
  real,dimension(:),allocatable                                         :: r 
                                      
  	allocate(es(3))
	allocate(r(3))
  	allocate(lb(radio_struc%npts))
	allocate(f(radio_struc%npts,17))
	
	allocate(temp(int(radio_struc%gridDesc(2)), int(radio_struc%gridDesc(3))))
	sites(:)%ct			= 0    
	
	inquire (file=trim(fname), exist=file_exists)
	if(file_exists)then 
		open(unit=255, file=trim(fname), status='old')
		do 
			read(255,'(A)',iostat=istat)lineStream
			if(istat .ne. 0)exit		
			
			if(lineStream(1:3) .eq. 'EST')then
				read(lineStream(4:8),'(I)')siteId
			else
				read(lineStream,*)h, p, tc, td, dir, mag
				if(p .eq. 925 .or. p .eq. 850 .or. p .eq. 500 .or. p .eq. 250)then
					sites(siteId)%ct			= sites(siteId)%ct + 1
					sites(siteId)%h(sites(siteId)%ct)	= h
					sites(siteId)%p(sites(siteId)%ct)	= p
					sites(siteId)%tc(sites(siteId)%ct)	= tc
					sites(siteId)%td(sites(siteId)%ct)	= td
					sites(siteId)%dir(sites(siteId)%ct)	= dir
					sites(siteId)%mag(sites(siteId)%ct)	= mag
					!!print*, trim(lineStream), sites(siteId)%ct

		
				end if

			end if
		end do
	
	else
	
		stop 'file not found'
	end if
	
	f = -9999.0
	
	do siteId = 80001, 87860

		if(sites(siteId)%ct .eq. 4)then
		
		
			px = ((sites(siteId)%coord(2) - radio_struc%gridDesc(5))/radio_struc%gridDesc( 10) ) + 1
			py = ((radio_struc%gridDesc(7) - sites(siteId)%coord(1))/radio_struc%gridDesc( 9) ) + 1

			if(px .gt. 0 .and. px .le. radio_struc%gridDesc(2) .and. py .gt. 0 .and. py .le. radio_struc%gridDesc(3))then

				do i=1,3
				
					es(i)=6.122*exp((17.65*sites(siteId)%td(i))/(sites(siteId)%td(i) + 2433.5))
					r(i)=(e*es(i))/(sites(siteId)%p(i) - es(i))

				enddo
				!ZGEO
				!f( (((py-1)*radio_struc%gridDesc(2)) + px), 1) = sites(siteId)%h(2)*9.8
				!f( (((py-1)*radio_struc%gridDesc(2)) + px), 2) = sites(siteId)%h(3)*9.8
				!f( (((py-1)*radio_struc%gridDesc(2)) + px), 3) = sites(siteId)%h(4)*9.8
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 1) =-9999.0! sites(siteId)%h(2)*9.8
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 2) =-9999.0 !sites(siteId)%h(3)*9.8
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 3) =-9999.0! sites(siteId)%h(4)*9.8
				
				!UVEL
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 4)= - sites(siteId)%mag(2)*sin((pi/180)*sites(siteId)%dir(2))
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 5)= - sites(siteId)%mag(3)*sin((pi/180)*sites(siteId)%dir(3))
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 6)= - sites(siteId)%mag(4)*sin((pi/180)*sites(siteId)%dir(4))
				!UMES
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 7)= (r(1)*(10**-3))/(1+r(1))
				!VVEL
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 10)= - sites(siteId)%mag(2)*cos((pi/180)*sites(siteId)%dir(2))
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 11)= - sites(siteId)%mag(3)*cos((pi/180)*sites(siteId)%dir(3))
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 12)= - sites(siteId)%mag(4)*cos((pi/180)*sites(siteId)%dir(4))
				!PSNM
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 13)= -9999.0
				!VTMP
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 14)= (1+(r(1)/e))/(1+r(1))
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 15)= (1+(r(2)/e))/(1+r(2))
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 16)= (1+(r(3)/e))/(1+r(3))
				!AGPL
				f( (((py-1)*radio_struc%gridDesc(2)) + px), 17)=-9999.0

			end if
			
			    	
			
		end if
	end do
	
	!ATENCAO!
	!-- variaveis do modelo diferem no posicionamento do undef --! 
	!-- ao inves de utilizar uma mascara recomendo controlar computa\E7\E3o pela variavel undef --!
	!lb = .true.
	!where(f(:,1) .lt. -9999.999) lb = .false.
	
	allocate(f2(radio_struc%npts,scamtec%nvar))

	


  
	f2(:, 1) = f(:, 14)				 ! Vtmp @ 925 hPa [K]
 	f2(:, 2) = f(:, 15) 				 ! Vtmp @ 850 hPa [K]
	f2(:, 3) = f(:, 16)				 ! Vtmp @ 500 hPa [K]
	f2(:, 4) = f(:, 13)                              ! PSNM [hPa]
	f2(:, 5) = f(:, 7)				 ! Umes @ 925 hPa [Kg/Kg]
	f2(:, 6) = f(:, 17)				 ! Agpl @ 925 hPa [Kg/m2]
	f2(:, 7) = f(:, 1)				 ! Zgeo @ 850 hPa [gpm]
	f2(:, 8) = f(:, 2)				 ! Zgeo @ 500 hPa [gpm]
	f2(:, 9) = f(:, 3)				 ! Zgeo @ 250 hPa [gpm]
	f2(:,10) = f(:, 4)				 ! Uvel @ 850 hPa [m/s]
	f2(:,11) = f(:, 5)				 ! Uvel @ 500 hPa [m/s]
	f2(:,12) = f(:, 6)				 ! Uvel @ 250 hPa [m/s]
	f2(:,13) = f(:, 10)				 ! Vvel @ 850 hPa [m/s]
	f2(:,14) = f(:, 11)				 ! Vvel @ 500 hPa [m/s]
	f2(:,15) = f(:, 12)				 ! Vvel @ 250 hPa [m/s]

	print*,maxval(f2(:,10)),"maximo radio"
	print*,minval(f2(:,10)),"minimo radio"
	deallocate(f)



    !
    ! invertendo y
    !

	allocate(f(radio_struc%npts,scamtec%nvar))
    

	!nx = int(radio_struc%gridDesc(2))
	!ny = int(radio_struc%gridDesc(3))

 
 	!k = 0
 	!do j = 1, ny
    !		do i = 1, nx
     !  			f(i+(nx*ny)-nx-k,:) = f2(i+k,:)
    !		enddo
  	!	k = k + nx
	!enddo
		
	f = f2

 	deallocate(f2)

    !
    ! Interpolando para a grade do SCAMTEC
    !

    nx = int(scamtec%gridDesc(2))
    ny = int(scamtec%gridDesc(3))
    
    allocate(varfield(nx,ny))
    DO iv = 1, scamtec%nvar

	lb = .false.
	where(f(:,iv) .gt. -9999.0) lb = .true.

       	call interp_radio( kpds, radio_struc%npts,f(:,iv),lb, scamtec%gridDesc,&
                              scamtec%nxpt,scamtec%nypt, varfield)    

    !
    ! Transferindo para matriz temporaria do SCAMTEC
    !
       scamdata(1)%tmpfield(:,:,iv) = varfield(:,:)

    enddo
  deallocate(es)
  deallocate(r)
 end subroutine radio_read 
 
  SUBROUTINE interp_radio( kpds, npts,f,lb,gridDesc, nxpt, nypt, varfield)  

    ! !ARGUMENTS:   
    integer, intent(in)   :: kpds(:)
    integer, intent(in)   :: npts
    real, intent(out)     :: f(:)
    logical*1, intent(in) :: lb(:)
    real, intent(in)      :: gridDesc(:)
    integer, intent(in)   :: nxpt
    integer, intent(in)   :: nypt
    real, intent(out)     :: varfield(:,:)

    !
    !
    !

    real, dimension(nxpt*nypt) :: field1d
    logical*1, dimension(nxpt,nypt) :: lo

    integer :: ip, ipopt(20),ibi,km,iret
    integer :: ibo
    integer :: i,j,k

    character(len=*),parameter :: myname_=myname//'::interp_radio'

#ifdef DEBUG
    WRITE(6,'(     2A)')'Hello from ', myname_
#endif

    ip    = 0
    ipopt = 0
    km    = 1
    ibi   = 1
    lo    = .true.

    call bilinear_interp(gridDesc,ibi,lb,f,ibo,lo,field1d,   &
                         radio_struc%npts,nxpt*nypt,          &
                         radio_struc%rlat1, radio_struc%rlon1, &
                         radio_struc%w111, radio_struc%w121,   &
                         radio_struc%w211, radio_struc%w221,   &
                         radio_struc%n111, radio_struc%n121,   &
                         radio_struc%n211, radio_struc%n221,scamtec%udef,iret)

    k = 0
    do j = 1, nypt
       do i = 1, nxpt
          varfield(i,j) = field1d(i+k)
       enddo
       k = k + nxpt
    enddo

  END SUBROUTINE interp_radio



end module m_radiossonda
